<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GreenSync ‚Äî Realtime Dashboard (Premium Chart)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+Thai:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--border:#e9e9ef;--text:#1f2430;--muted:#697089;--primary:#22a16f;--primary-weak:#e7f7f0;}
    body{margin:16px;background:var(--bg);color:var(--text);
         font-family:"Noto Sans Thai","Inter",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;}
    h1{font-size:20px;margin:0;font-weight:700}
    header{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    input,select,button{padding:7px 9px;border-radius:8px;border:1px solid var(--border);font:inherit}
    input:focus,select:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 2px var(--primary-weak)}
    button{background:var(--primary);color:#fff;border:none;font-weight:600;cursor:pointer;padding:8px 12px}
    button:hover{filter:brightness(0.95)}
    button.ghost{background:#fff;color:var(--primary);border:1px solid var(--primary)}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;margin:10px 0 12px}
    .card{background:var(--card);border-radius:12px;border:1px solid var(--border);box-shadow:0 4px 14px rgba(0,0,0,.04);padding:10px}
    .label{font-size:11px;color:var(--muted)}
    .value{font-size:20px;font-weight:700;font-family:"Inter","Noto Sans Thai"}
    .npk{background:#f6fff9;border-color:#d4f2e3}
    .chart-wrap{background:var(--card);border-radius:12px;border:1px solid var(--border);box-shadow:0 4px 14px rgba(0,0,0,.04);padding:10px;margin:12px 0}
    .table-wrap{overflow:auto;background:var(--card);border-radius:12px;border:1px solid var(--border);box-shadow:0 4px 14px rgba(0,0,0,.04);padding:6px}
    table{border-collapse:collapse;width:100%;min-width:640px}
    th,td{border-bottom:1px solid #f0f1f5;padding:4px 6px;text-align:left;font-size:11px;line-height:1.3}
    th{background:#fafbff;position:sticky;top:0}
    tr:hover td{background:#fafcff}
    .footer{color:var(--muted);font-size:11px;margin-top:6px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>üåø GreenSync ‚Äî Realtime Dashboard</h1>
    <div class="controls">
      <label>Sensor:<input id="sensor" value="esp32" /></label>
      <label>Rows:<select id="limit"><option>20</option><option selected>100</option></select></label>
      <button id="start">Start</button>
      <button id="stop" class="ghost">Stop</button>
      <span id="status" class="footer"></span>
    </div>
  </header>

  <section class="cards" id="cards"></section>

  <section class="chart-wrap">
    <canvas id="lineChart" height="92"></canvas>
  </section>

  <section class="table-wrap">
    <table id="dataTable"><thead></thead><tbody></tbody></table>
    <div class="footer" id="info"></div>
  </section>

<script>
/* ===== CONFIG ===== */
const API_URL="YOUR_WEB_APP_URL_HERE"; // <-- ‡πÉ‡∏™‡πà URL Web App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const SENSOR_NAME_DEFAULT="esp32";
const POLL_MS=2000;
const $=id=>document.getElementById(id);

/* ===== STATE ===== */
let chart,pollTimer,lastRowIndex=1,header=[];
let labels=[],temps=[],humids=[],pm25s=[];
let queueRows=[]; // 5 ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á

/* ===== Helpers ===== */
function makeGrad(ctx, rgba){
  const g=ctx.createLinearGradient(0,0,0,260);
  g.addColorStop(0, rgba.replace('1)', '0.25)'));
  g.addColorStop(0.5, rgba.replace('1)', '0.10)'));
  g.addColorStop(1, rgba.replace('1)', '0.02)'));
  return g;
}

/* ===== Chart.js plugin: shadow under line ===== */
const shadowLinePlugin = {
  id: 'shadowLine',
  beforeDatasetDraw(chart, args) {
    const {ctx} = chart;
    const ds = chart.config.data.datasets[args.index];
    if (!ds || !ds.borderColor) return;
    ctx.save();
    ctx.shadowColor = ds.borderColor;
    ctx.shadowBlur = 10;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 3;
  },
  afterDatasetDraw(chart) { chart.ctx.restore(); }
};

/* ===== API ===== */
async function apiExport({sensor,limit,order="asc",after=0}){
  const u=new URL(API_URL);
  u.searchParams.set("action","export");
  u.searchParams.set("sensor",sensor);
  u.searchParams.set("order",order);
  after>0?u.searchParams.set("after",after):u.searchParams.set("limit",limit);
  const t0=performance.now();
  const r=await fetch(u);
  if(!r.ok)throw new Error(`HTTP ${r.status}`);
  const d=await r.json();
  $("status").textContent=`Loaded ${d.count} rows in ${(performance.now()-t0).toFixed(0)} ms`;
  return d;
}

/* ===== RENDER: cards ===== */
function renderCards(v){
  const c=$("cards"); c.innerHTML="";
  const envPairs=[
    ["Time", v["Timestamp (Asia/Bangkok)"]],
    ["Soil", v["Soil Moisture (%)"]+" %"],
    ["Light", v["Light (%)"]+" %"],
    ["Humid", v["Air Humidity (%)"]+" %"],
    ["Temp", v["Temperature (¬∞C)"]+" ¬∞C"],
    ["PM1.0", v["PM1.0 (¬µg/m¬≥)"]],
    ["PM2.5", v["PM2.5 (¬µg/m¬≥)"]],
    ["PM10", v["PM10 (¬µg/m¬≥)"]],
  ];
  for(const [label,val] of envPairs){
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`<div class="label">${label}</div><div class="value">${val ?? "-"}</div>`;
    c.appendChild(div);
  }
  const npkPairs=[
    ["N", v["N (mg/kg)"]!==undefined? v["N (mg/kg)"]+" mg/kg" : "-"],
    ["P", v["P (mg/kg)"]!==undefined? v["P (mg/kg)"]+" mg/kg" : "-"],
    ["K", v["K (mg/kg)"]!==undefined? v["K (mg/kg)"]+" mg/kg" : "-"],
  ];
  for(const [label,val] of npkPairs){
    const div=document.createElement("div");
    div.className="card npk";
    div.innerHTML=`<div class="label">Nutrient: ${label}</div><div class="value">${val}</div>`;
    c.appendChild(div);
  }
}

/* ===== RENDER: table (queue 5 latest) ===== */
function initTable(h){
  header=h;
  const thead=$("dataTable").querySelector("thead");
  thead.innerHTML="<tr>"+h.map(x=>`<th>${x}</th>`).join("")+"</tr>";
  $("dataTable").querySelector("tbody").innerHTML="";
  queueRows=[];
}
function updateTable(){
  const tb=$("dataTable").querySelector("tbody");
  tb.innerHTML = queueRows.map(r =>
    "<tr>"+header.map(h=>`<td>${r[h]??""}</td>`).join("")+"</tr>"
  ).join("");
}

/* ===== CHART (premium styling) ===== */
function ensureChart(){
  if(chart) return;
  const ctx=$("lineChart").getContext("2d");
  const cT="rgba(34,161,111,1)", cH="rgba(64,99,187,1)", cP="rgba(232,94,106,1)";
  chart = new Chart(ctx, {
    type: "line",
    plugins:[shadowLinePlugin],
    data: {
      labels,
      datasets: [
        { label:"Temp ¬∞C",  data:temps,  borderColor:cT, backgroundColor:makeGrad(ctx,cT), fill:true,
          tension:0.35, borderWidth:2.2, pointRadius:0, pointHoverRadius:4, hitRadius:10, spanGaps:true },
        { label:"Humidity %", data:humids, borderColor:cH, backgroundColor:makeGrad(ctx,cH), fill:true,
          tension:0.35, borderWidth:2.2, pointRadius:0, pointHoverRadius:4, hitRadius:10, spanGaps:true },
        { label:"PM2.5",    data:pm25s, borderColor:cP, backgroundColor:makeGrad(ctx,cP), fill:true,
          tension:0.35, borderWidth:2.2, pointRadius:0, pointHoverRadius:4, hitRadius:10, spanGaps:true }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      animation:{ duration:450, easing:'easeOutQuart' },
      interaction:{ mode:'index', intersect:false },
      plugins:{
        legend:{ position:'top', labels:{ usePointStyle:true, padding:12, font:{family:'Inter'} } },
        title:{ display:true, text:'Environment (Realtime)', font:{family:'Inter', weight:600, size:16} },
        tooltip:{
          backgroundColor:'#1f2430', padding:10,
          titleFont:{family:'Inter', weight:'700'}, bodyFont:{family:'Inter'},
          callbacks:{ label:ctx=>` ${ctx.dataset.label}: ${ctx.parsed.y}` }
        },
        decimation:{ enabled:true, algorithm:'lttb', samples:200 } // ‡πÄ‡∏£‡πà‡∏á performance ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡πÄ‡∏¢‡∏≠‡∏∞
      },
      scales:{
        x:{ grid:{ color:'rgba(0,0,0,0.05)' }, ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit:8, font:{family:'Inter'} } },
        y:{ beginAtZero:false, grace:'10%', grid:{ color:'rgba(0,0,0,0.05)' }, ticks:{ font:{family:'Inter'} } }
      }
    }
  });
}
function appendToSeries(rows){
  for(const r of rows){
    labels.push(r["Timestamp (Asia/Bangkok)"]);
    temps.push(+r["Temperature (¬∞C)"]||0);
    humids.push(+r["Air Humidity (%)"]||0);
    pm25s.push(+r["PM2.5 (¬µg/m¬≥)"]||0);
  }
  // ‡πÅ‡∏™‡∏î‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 50 ‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∑‡πà‡∏ô
  const MAX_POINTS=50;
  if(labels.length>MAX_POINTS){
    const cut=labels.length-MAX_POINTS;
    labels.splice(0,cut); temps.splice(0,cut); humids.splice(0,cut); pm25s.splice(0,cut);
  }
  chart && chart.update('none');
}

/* ===== FLOWS ===== */
async function initialLoad(){
  const s=$("sensor").value.trim()||SENSOR_NAME_DEFAULT;
  const l=parseInt($("limit").value)||100;
  $("status").textContent="Loading...";
  const d=await apiExport({sensor:s,limit:l});
  initTable(d.header);
  labels.length=temps.length=humids.length=pm25s.length=0;

  queueRows = d.rows.slice(-5); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ 5 ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  updateTable();

  appendToSeries(d.rows);
  ensureChart();

  if (d.rows.length) renderCards(d.rows.at(-1));
  $("info").textContent=`Sheet: ${d.sheet} ‚Ä¢ Loaded ${d.count}`;
  lastRowIndex=d.lastRow || 1;
}

async function pollNewRows(){
  const s=$("sensor").value.trim()||SENSOR_NAME_DEFAULT;
  const d=await apiExport({sensor:s,order:"asc",after:lastRowIndex});
  if(!d.rows?.length) return;

  // ‡∏Ñ‡∏¥‡∏ß 5 ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  for(const row of d.rows){
    queueRows.push(row);
    if(queueRows.length>5) queueRows.shift();
  }
  updateTable();

  appendToSeries(d.rows);
  renderCards(queueRows.at(-1));
  $("info").textContent=`Sheet: ${d.sheet} ‚Ä¢ Showing last 5 rows`;
  lastRowIndex=d.lastRow || lastRowIndex;
}

function startRealtime(){ if(pollTimer) return; pollTimer=setInterval(pollNewRows,POLL_MS); $("status").textContent="Realtime: ON"; }
function stopRealtime(){ if(!pollTimer) return; clearInterval(pollTimer); pollTimer=null; $("status").textContent="Realtime: OFF"; }

/* ===== BINDINGS ===== */
$("start").onclick=async()=>{ stopRealtime(); await initialLoad(); startRealtime(); };
$("stop").onclick=stopRealtime;
window.onload=async()=>{ await initialLoad(); startRealtime(); };
</script>
</body>
</html>
