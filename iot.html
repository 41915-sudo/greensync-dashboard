<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üåø GreenSync ‚Äî Realtime Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+Thai:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Light theme (default) */
      --bg:#f5f7fa; --text:#1f2430; --muted:#667085;
      --card:#ffffff; --border:#e5e7eb;
      --shadow:0 4px 16px rgba(0,0,0,.06);
      --table-hover:#f9fffa;
      /* Accent palette */
      --green1:#22a16f; --green2:#a6f2c3;
      --blue1:#4285f4;  --blue2:#cfe2ff;
      --red1:#ef4444;   --red2:#fecaca;
      --amber1:#f59e0b; --amber2:#fde68a;
      --chart-grid: rgba(0,0,0,0.08);
      --chart-legend: #1f2430;
      --tooltip-bg:#1f2430; --tooltip-fg:#fff;
    }
    /* Dark theme override */
    [data-theme="dark"]{
      --bg:#0e141b; --text:#e6e9ee; --muted:#9aa5b1;
      --card:#131a22; --border:#1f2a36;
      --shadow:0 8px 24px rgba(0,0,0,.35);
      --table-hover:#0f1d17;
      --green1:#2bd18a; --green2:#0c3;   /* ‡πÇ‡∏ó‡∏ô‡∏™‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡πÉ‡∏ô‡∏î‡∏≤‡∏£‡πå‡∏Å */
      --blue1:#6aa8ff;  --blue2:#18314f;
      --red1:#ff6b6b;   --red2:#3b0f12;
      --amber1:#ffbe55; --amber2:#3a2a08;
      --chart-grid: rgba(255,255,255,0.12);
      --chart-legend:#e6e9ee;
      --tooltip-bg:#0b1117; --tooltip-fg:#e6e9ee;
    }

    *{box-sizing:border-box}
    body{
      margin:16px;background:var(--bg);color:var(--text);
      font-family:"Noto Sans Thai","Inter",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      transition: background .25s ease, color .25s ease;
    }
    h1{font-size:22px;margin:0;font-weight:700}
    header{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    input,select,button{
      padding:7px 10px;border-radius:10px;border:1px solid var(--border);font:inherit;background:var(--card);color:var(--text)
    }
    input:focus,select:focus{outline:none;border-color:var(--green1);box-shadow:0 0 0 2px color-mix(in oklab, var(--green1) 25%, transparent)}
    button.primary{background:var(--green1);border-color:var(--green1);color:#fff}
    button.ghost{background:var(--card);color:var(--green1);border-color:var(--green1)}
    button:hover{filter:brightness(0.98)}
    .toggle{
      display:inline-flex;align-items:center;gap:6px;padding:6px 10px;cursor:pointer;
    }

    .cards{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
      gap:10px;margin:12px 0 16px
    }
    .card{
      position:relative;overflow:hidden;background:var(--card);border:1px solid var(--border);
      border-radius:14px;box-shadow:var(--shadow);padding:12px 10px;
    }
    .card::before{
      content:"";position:absolute;inset:0;border-radius:inherit;z-index:0;
      background:linear-gradient(135deg,var(--c1),var(--c2));
      opacity:.22; /* ‡πÑ‡∏•‡πà‡πÄ‡∏â‡∏î‡∏ö‡∏≤‡∏á ‡πÜ */
    }
    .card .label{font-size:12px;color:var(--muted);position:relative;z-index:1}
    .card .value{font-size:22px;font-weight:700;position:relative;z-index:1;font-family:"Inter","Noto Sans Thai"}

    /* ‡∏´‡∏°‡∏ß‡∏î‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î */
    .time {--c1:#64748b;--c2:#cbd5e1;}
    [data-theme="dark"] .time {--c1:#334155;--c2:#0b1220;}

    .soil,.light{--c1:var(--green1);--c2:color-mix(in oklab,var(--green2) 50%, transparent)}
    .humid,.temp{--c1:var(--blue1); --c2:color-mix(in oklab,var(--blue2) 60%, transparent)}
    .pm{--c1:var(--red1); --c2:color-mix(in oklab,var(--red2) 60%, transparent)}
    .npk{--c1:var(--amber1);--c2:color-mix(in oklab,var(--amber2) 60%, transparent)}

    .chart-wrap{
      background:var(--card);border-radius:16px;border:1px solid var(--border);
      box-shadow:var(--shadow);padding:10px;margin:16px 0;overflow:hidden
    }
    .chart-wrap canvas{width:100%!important;height:100%!important}
    .table-wrap{
      overflow:auto;background:var(--card);border-radius:12px;border:1px solid var(--border);
      box-shadow:var(--shadow);padding:6px
    }
    table{border-collapse:collapse;width:100%;min-width:640px}
    th,td{border-bottom:1px solid var(--border);padding:6px 8px;text-align:left;font-size:12px;line-height:1.3;color:var(--text)}
    th{background:color-mix(in oklab,var(--card) 70%, #fff 30%);position:sticky;top:0}
    tr:hover td{background:var(--table-hover)}
    .footer{color:var(--muted);font-size:11px;margin-top:6px}

    /* Chart sizes */
    body.chart-normal .chart-wrap{height:300px;}
    body.chart-large  .chart-wrap{height:480px;}
    body.chart-full   .chart-wrap{height:80vh;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="chart-large" data-theme="light">
  <header>
    <h1>üåø GreenSync ‚Äî Realtime Dashboard</h1>
    <div class="controls">
      <label>Sensor:<input id="sensor" value="esp32" /></label>
      <label>Rows:
        <select id="limit"><option>20</option><option selected>100</option></select>
      </label>
      <label>Chart:
        <select id="chartSize">
          <option value="normal">Normal</option>
          <option value="large" selected>Large</option>
          <option value="full">Full</option>
        </select>
      </label>
      <button id="start" class="primary">Start</button>
      <button id="stop" class="ghost">Stop</button>
      <button id="themeBtn" class="toggle ghost" title="Toggle theme">üåô Dark</button>
      <span id="status" class="footer"></span>
    </div>
  </header>

  <section class="cards" id="cards"></section>

  <section class="chart-wrap">
    <canvas id="lineChart"></canvas>
  </section>

  <section class="table-wrap">
    <table id="dataTable"><thead></thead><tbody></tbody></table>
    <div class="footer" id="info"></div>
  </section>

<script>
/* ===== CONFIG ===== */
const API_URL="https://script.google.com/macros/s/AKfycbyEMeOfF9wqrsoduyFCIlxid7lFzzOqXsIN_GxO9V6QgUY_OXx5atJKZd0fkMlg7P9mbw/exec";
const SENSOR_NAME_DEFAULT="esp32";
const POLL_MS=2000;
const THEME_KEY="gs-theme";
const $=id=>document.getElementById(id);

/* ===== STATE ===== */
let chart,pollTimer,lastRowIndex=1,header=[];
let labels=[],temps=[],humids=[],pm25s=[],queueRows=[];

/* ===== Helpers ===== */
const shadowLinePlugin={id:'shadowLine',beforeDatasetDraw(c,a){const{ctx}=c;const d=c.config.data.datasets[a.index];if(!d)return;ctx.save();ctx.shadowColor=d.borderColor;ctx.shadowBlur=10;ctx.shadowOffsetY=3;},afterDatasetDraw(c){c.ctx.restore();}};
function makeGrad(ctx,rgba,alphaTop=.30,alphaBottom=.06){
  const g=ctx.createLinearGradient(0,0,0,260);
  g.addColorStop(0,rgba.replace('1)',`${alphaTop})`));
  g.addColorStop(1,rgba.replace('1)',`${alphaBottom})`));
  return g;
}
async function apiExport({sensor,limit,order="asc",after=0}){
  const u=new URL(API_URL);
  u.searchParams.set("action","export");
  u.searchParams.set("sensor",sensor);
  u.searchParams.set("order",order);
  u.searchParams.set("_t",Date.now()); // no-cache
  after>0?u.searchParams.set("after",after):u.searchParams.set("limit",limit);
  const r=await fetch(u); if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return await r.json();
}

/* ===== Cards ===== */
function renderCards(v){
  const c=$("cards"); c.innerHTML="";
  const list=[
    ["Time",v["Timestamp (Asia/Bangkok)"],"time"],
    ["Soil",v["Soil Moisture (%)"]+" %","soil"],
    ["Light",v["Light (%)"]+" %","light"],
    ["Humid",v["Air Humidity (%)"]+" %","humid"],
    ["Temp",v["Temperature (¬∞C)"]+" ¬∞C","temp"],
    ["PM1.0",v["PM1.0 (¬µg/m¬≥)"],"pm"],
    ["PM2.5",v["PM2.5 (¬µg/m¬≥)"],"pm"],
    ["PM10",v["PM10 (¬µg/m¬≥)"],"pm"],
    ["N",v["N (mg/kg)"]+" mg/kg","npk"],
    ["P",v["P (mg/kg)"]+" mg/kg","npk"],
    ["K",v["K (mg/kg)"]+" mg/kg","npk"],
  ];
  list.forEach(([label,val,cls])=>{
    const d=document.createElement("div");
    d.className=`card ${cls}`;
    d.innerHTML=`<div class="label">${label}</div><div class="value">${val??"-"}</div>`;
    c.appendChild(d);
  });
}

/* ===== Table (5 latest queue) ===== */
function initTable(h){
  header=h;
  $("dataTable").querySelector("thead").innerHTML="<tr>"+h.map(x=>`<th>${x}</th>`).join("")+"</tr>";
  $("dataTable").querySelector("tbody").innerHTML="";
  queueRows=[];
}
function updateTable(){
  $("dataTable").querySelector("tbody").innerHTML =
    queueRows.map(r => "<tr>"+header.map(h=>`<td>${r[h]??""}</td>`).join("")+"</tr>").join("");
}

/* ===== Chart ===== */
function ensureChart(){
  if(chart) return;
  const ctx=$("lineChart").getContext("2d");
  const cT="rgba(34,161,111,1)", cH="rgba(66,133,244,1)", cP="rgba(239,68,68,1)";
  chart = new Chart(ctx,{
    type:"line",
    plugins:[shadowLinePlugin],
    data:{labels,
      datasets:[
        {label:"Temp ¬∞C",data:temps,borderColor:"#22a16f",backgroundColor:makeGrad(ctx,cT),fill:true,tension:.35,borderWidth:2,pointRadius:0,spanGaps:true},
        {label:"Humidity %",data:humids,borderColor:"#4285f4",backgroundColor:makeGrad(ctx,cH),fill:true,tension:.35,borderWidth:2,pointRadius:0,spanGaps:true},
        {label:"PM2.5",data:pm25s,borderColor:"#ef4444",backgroundColor:makeGrad(ctx,cP),fill:true,tension:.35,borderWidth:2,pointRadius:0,spanGaps:true}
      ]},
    options:{
      responsive:true,maintainAspectRatio:false,
      interaction:{mode:"index",intersect:false},
      plugins:{
        legend:{position:"top",labels:{color:getCss('--chart-legend')}},
        title:{display:true,text:"Environment (Realtime)",color:getCss('--chart-legend')},
        tooltip:{backgroundColor:getCss('--tooltip-bg'),titleColor:getCss('--tooltip-fg'),bodyColor:getCss('--tooltip-fg')}
      },
      scales:{
        x:{ticks:{maxRotation:0,autoSkip:true,maxTicksLimit:8,color:getCss('--chart-legend')},
           grid:{color:getCss('--chart-grid')}},
        y:{grace:"10%",ticks:{color:getCss('--chart-legend')},
           grid:{color:getCss('--chart-grid')}}
      }
    }
  });
}
function appendToSeries(rows){
  rows.forEach(r=>{
    labels.push(r["Timestamp (Asia/Bangkok)"]);
    temps.push(+r["Temperature (¬∞C)"]||0);
    humids.push(+r["Air Humidity (%)"]||0);
    pm25s.push(+r["PM2.5 (¬µg/m¬≥)"]||0);
  });
  if(labels.length>50){
    const cut=labels.length-50;
    labels.splice(0,cut); temps.splice(0,cut); humids.splice(0,cut); pm25s.splice(0,cut);
  }
  chart && chart.update('none');
}

/* ===== Theme ===== */
function getCss(varName){return getComputedStyle(document.body).getPropertyValue(varName).trim();}
function applyThemeToChart(){
  if(!chart) return;
  const legend = getCss('--chart-legend'), grid = getCss('--chart-grid');
  const ttbg = getCss('--tooltip-bg'), ttf = getCss('--tooltip-fg');
  chart.options.plugins.legend.labels.color = legend;
  chart.options.plugins.title.color = legend;
  chart.options.plugins.tooltip.backgroundColor = ttbg;
  chart.options.plugins.tooltip.titleColor = ttf;
  chart.options.plugins.tooltip.bodyColor = ttf;
  chart.options.scales.x.ticks.color = legend;
  chart.options.scales.y.ticks.color = legend;
  chart.options.scales.x.grid.color = grid;
  chart.options.scales.y.grid.color = grid;
  chart.update('none');
}
function setTheme(mode){
  document.body.setAttribute('data-theme', mode);
  $("themeBtn").textContent = (mode === 'dark') ? "‚òÄÔ∏è Light" : "üåô Dark";
  localStorage.setItem(THEME_KEY, mode);
  applyThemeToChart();
}
function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  if(saved){ setTheme(saved); }
  else{
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    setTheme(prefersDark ? 'dark' : 'light');
  }
}

/* ===== Flows ===== */
async function initialLoad(){
  const s=$("sensor").value.trim()||SENSOR_NAME_DEFAULT;
  const l=parseInt($("limit").value)||100;
  $("status").textContent="Loading...";
  const d=await apiExport({sensor:s,limit:l});
  initTable(d.header);
  labels.length=temps.length=humids.length=pm25s.length=0;
  queueRows = d.rows.slice(-5);
  updateTable();
  appendToSeries(d.rows);
  ensureChart();
  if(d.rows.length) renderCards(d.rows.at(-1));
  $("info").textContent=`Sheet: ${d.sheet} ‚Ä¢ Showing last 5 rows`;
  lastRowIndex = d.lastRow || 1;
}
async function pollNewRows(){
  const s=$("sensor").value.trim()||SENSOR_NAME_DEFAULT;
  const d=await apiExport({sensor:s,order:"asc",after:lastRowIndex});
  if(!d.rows?.length) return;
  d.rows.forEach(row=>{ queueRows.push(row); if(queueRows.length>5) queueRows.shift(); });
  updateTable();
  appendToSeries(d.rows);
  renderCards(queueRows.at(-1));
  $("info").textContent=`Sheet: ${d.sheet} ‚Ä¢ Showing last 5 rows`;
  lastRowIndex = d.lastRow || lastRowIndex;
}
function startRealtime(){ if(pollTimer) return; pollTimer=setInterval(pollNewRows,POLL_MS); $("status").textContent="Realtime: ON"; }
function stopRealtime(){ if(!pollTimer) return; clearInterval(pollTimer); pollTimer=null; $("status").textContent="Realtime: OFF"; }

/* ===== Bindings ===== */
$("chartSize").addEventListener("change", ()=>{
  document.body.classList.remove("chart-normal","chart-large","chart-full");
  document.body.classList.add(`chart-${$("chartSize").value}`);
  chart && chart.resize();
});
new ResizeObserver(()=>{ chart && chart.resize(); }).observe(document.querySelector(".chart-wrap"));
$("themeBtn").addEventListener("click", ()=>{
  const now = document.body.getAttribute('data-theme');
  setTheme(now === 'dark' ? 'light' : 'dark');
});
$("start").onclick = async()=>{ stopRealtime(); await initialLoad(); startRealtime(); };
$("stop").onclick  = stopRealtime;

initTheme();                 // <‚Äî ‡πÇ‡∏´‡∏•‡∏î‡∏ò‡∏µ‡∏°‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏µ‡∏Å‡∏£‡∏≤‡∏ü‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏£‡∏Å
window.onload = async()=>{ await initialLoad(); startRealtime(); };
</script>
</body>
</html>
